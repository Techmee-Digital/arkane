{% extends "base.html" %}
{% block content %}

<!-- Background: shooting-star (rain removed) -->
<div class="bg-effects">
  <div class="stars"></div>
  <div class="shooting-star"></div>
  <div class="shooting-star"></div>
  <div class="shooting-star"></div>
</div>

<div class="content-wrapper">
  {% if active_tab=='duplicate' %}
    <div class="card">
        <div class="card-header">Duplicate Checker</div>
        <div class="card-body">
            <form id="dedupeForm" method="post" enctype="multipart/form-data" class="d-flex align-items-end mb-4 gap-3 needs-loading-spinner">
                <input type="hidden" name="action" value="dedupe">
                <div class="flex-grow-1">
                    <label for="file_upload" class="form-label">Upload Excel Files</label>
                    <input type="file" name="file_upload" id="file_upload" multiple accept=".xls,.xlsx" required class="form-control">
                </div>
                <button type="submit" class="Button">
                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                    <span class="Button-content">Run Check</span>
                    <svg class="Button-svg" viewBox="0 0 220 50">
                        <polyline class="Button-line Button-line--outer" points="1 1, 219 1, 219 49, 1 49, 1 1"></polyline>
                        <polyline class="Button-line Button-line--inner" points="1 1, 219 1, 219 49, 1 49, 1 1"></polyline>
                    </svg>
                </button>
                <a href="{{ url_for('tools', tab='duplicate') }}" class="btn btn-secondary btn-liquid">
                    <span class="btn-text">Reset</span>
                </a>
            </form>
        </div>
    </div>
    
    {% if dedupe.token %}
      <div class="card dup-results">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Results</span>
          <div class="d-flex align-items-center gap-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="show_dups">
              <label class="form-check-label" for="show_dups">Show Duplicates Only</label>
            </div>
            <form method="post" class="d-inline needs-loading-spinner">
                <input type="hidden" name="action" value="save_all">
                <input type="hidden" name="token" value="{{ dedupe.token }}">
                <button class="btn btn-sm btn-success btn-liquid">
                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                    <span class="btn-text">Save All</span>
                </button>
            </form>
          </div>
        </div>
        <div class="card-body">
            <div class="alert alert-secondary dup-metrics d-flex justify-content-around p-2">
                <span>Total Leads: <strong>{{ dedupe.count_all }}</strong></span>
                <span>Duplicates: <strong>{{ dedupe.count_dup }}</strong></span>
                <span>Sources: <em>{{ dedupe.sources }}</em></span>
            </div>
            <div class="table-responsive">
                <table class="table table-hover dup-table">
                    <thead>
                        <tr>
                        {% for f in dedupe.fields %}<th>{{ f }}</th>{% endfor %}
                        <th>Origin</th>
                        <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in dedupe.rows %}
                        <tr data-dup="{{ '1' if r.duplicate else '0' }}" class="{{ 'table-warning' if r.duplicate }}">
                        {% for f in dedupe.fields %}<td>{{ r[f] }}</td>{% endfor %}
                        <td><small>{{ r.origin }}</small></td>
                        <td>
                            {% if r.duplicate %}
                            <span class="badge bg-warning text-dark">Duplicate</span>
                            {% else %}
                            <span class="badge bg-success">Unique</span>
                            {% endif %}
                        </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
      </div>
      <script>
        if (document.getElementById('show_dups')) {
            document.getElementById('show_dups').onchange = function () {
                document.querySelectorAll('tbody tr').forEach(tr => {
                    const isDuplicate = tr.dataset.dup === '1';
                    tr.style.display = (this.checked && !isDuplicate) ? 'none' : '';
                });
            };
        }
      </script>
    {% endif %}
  {% endif %}

  {% if active_tab=='search' %}
    <div class="card">
        <div class="card-header">Search by Email</div>
        <div class="card-body">
            <form method="post" class="needs-loading-spinner">
                <input type="hidden" name="action" value="search">
                <div class="input-group">
                    <input type="email" name="search_email" class="form-control form-control-lg" placeholder="Enter email" required>
                    <button type="submit" class="Button" style="width: 150px; height: 50px; border-radius: 0 0.5rem 0.5rem 0;">
                        <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                        <span class="Button-content">Search</span>
                        <svg class="Button-svg" viewBox="0 0 150 50">
                            <polyline class="Button-line Button-line--outer" points="1 1, 149 1, 149 49, 1 49, 1 1"></polyline>
                            <polyline class="Button-line Button-line--inner" points="1 1, 149 1, 149 49, 1 49, 1 1"></polyline>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% if search_results %}
    <div class="card">
        <div class="card-header">Search Results</div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Email</th><th>Company</th><th>Quarter</th><th>Campaign</th><th>Source</th><th>Exclusions</th><th>Uploaded</th>
                </tr>
                </thead>
                <tbody>
                {% for l in search_results %}
                <tr>
                    <td>{{ l.email }}</td>
                    <td>{{ l.company }}</td>
                    <td>{{ l.quarter }}</td>
                    <td>{{ l.campaign }}</td>
                    <td>{{ l.source_file }}</td>
                    <td>{{ l.exclusions }}</td>
                    <td>{{ l.upload_date.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
  {% endif %}

  {% if active_tab=='merge' %}
    <div class="card">
        <div class="card-header">Bulk Merge Excel Files</div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="d-flex align-items-end gap-3 needs-loading-spinner">
                <input type="hidden" name="action" value="merge">
                <div class="flex-grow-1">
                    <label class="form-label">Select Files to Merge</label>
                    <input type="file" name="file_merge" multiple accept=".xls,.xlsx" required class="form-control">
                </div>
                <button type="submit" class="Button">
                    <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                    <span class="Button-content">Merge Files</span>
                    <svg class="Button-svg" viewBox="0 0 220 50">
                        <polyline class="Button-line Button-line--outer" points="1 1, 219 1, 219 49, 1 49, 1 1"></polyline>
                        <polyline class="Button-line Button-line--inner" points="1 1, 219 1, 219 49, 1 49, 1 1"></polyline>
                    </svg>
                </button>
                {% if merge.download %}
                    <a href="{{ url_for('uploaded_file', filename=merge.download) }}" class="btn btn-success btn-liquid">
                        <span class="btn-text">Download Merged</span>
                    </a>
                {% endif %}
            </form>
        </div>
    </div>
    {% if merge.records %}
    <div class="card">
        <div class="card-header">Merged Preview (first 100 rows)</div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>{% for h in merge.headers %}<th>{{ h }}</th>{% endfor %}</tr>
                </thead>
                <tbody>
                    {% for r in merge.records[:100] %}
                    <tr>{% for h in merge.headers %}<td>{{ r[h] }}</td>{% endfor %}</tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
  {% endif %}

  {% if active_tab=='viewdb' %}
  <div class="card">
    <div class="card-header">Filter Leads</div>
    <div class="card-body">
      <form method="GET" class="needs-loading-spinner">
        <input type="hidden" name="tab" value="viewdb">
        <div class="row g-3 align-items-center">
            {% set filters = [('email', 'Email'), ('campaign', 'Campaign'), ('company', 'Company'), ('source', 'Source')] %}
            {% for name, label in filters %}
            <div class="col-md-6 col-lg-3 d-flex align-items-center">
                <div class="form-check form-switch me-2">
                  <input class="form-check-input" type="checkbox" id="chk{{ label }}" name="enable_{{ name }}" value="1" {% if request.values['enable_' + name] %}checked{% endif %}>
                  <label class="form-check-label" for="chk{{ label }}">{{ label }}</label>
                </div>
                <input type="text" name="filter_{{ name }}" value="{{ request.values['filter_' + name] or '' }}" class="form-control form-control-sm">
            </div>
            {% endfor %}
        </div>
        <hr class="my-3" style="border-color: var(--border-color);">
        <div class="d-flex justify-content-end gap-2 flex-wrap">
            <a href="{{ url_for('tools', tab='viewdb') }}" class="Button" style="width: 180px;">
                <span class="Button-content">Clear Filters</span>
                <svg class="Button-svg" viewBox="0 0 180 50"><polyline class="Button-line Button-line--outer" points="1 1, 179 1, 179 49, 1 49, 1 1"></polyline><polyline class="Button-line Button-line--inner" points="1 1, 179 1, 179 49, 1 49, 1 1"></polyline></svg>
            </a>
            <button type="submit" class="Button" style="width: 180px;">
                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                <span class="Button-content">Apply Filters</span>
                <svg class="Button-svg" viewBox="0 0 180 50"><polyline class="Button-line Button-line--outer" points="1 1, 179 1, 179 49, 1 49, 1 1"></polyline><polyline class="Button-line Button-line--inner" points="1 1, 179 1, 179 49, 1 49, 1 1"></polyline></svg>
            </button>
        </div>
      </form> 
    </div>
  </div>

  <div class="card no-header-hover">
    <form method="POST" id="leadsForm" class="needs-loading-spinner">
        <input type="hidden" name="action" id="action_hidden">
        <input type="hidden" name="admin_pass" id="admin_pass_hidden">
        {% for name, label in filters %}
            <input type="hidden" name="enable_{{ name }}" value="{% if request.values['enable_' + name] %}1{% endif %}">
            <input type="hidden" name="filter_{{ name }}" value="{{ request.values['filter_' + name] or '' }}">
        {% endfor %}
        
        <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
          <span>Database Leads ({{ pagination.total }}  results)</span>
          <div class="d-flex flex-wrap gap-2">
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-warning btn-liquid" data-bs-toggle="modal" data-bs-target="#passwordModal" data-action="update_selected"><span class="btn-text">Edit Selected</span></button>
                <button type="button" class="btn btn-sm btn-danger btn-liquid" data-bs-toggle="modal" data-bs-target="#passwordModal" data-action="delete_selected"><span class="btn-text">Delete Selected</span></button>
                <button type="button" class="btn btn-sm btn-info btn-liquid" id="btnDownloadSelected"><span class="btn-text">Download Selected</span></button>
            </div>
            <div class="btn-group">
                 <button type="button" class="btn btn-sm btn-info btn-liquid" id="btnDownloadFiltered"><span class="btn-text">Download Filtered</span></button>
                <button type="button" class="btn btn-sm btn-info btn-liquid" id="btnDownloadAll"><span class="btn-text">Download All</span></button>
            </div>
            {% if request.values.get('enable_source') and request.values.filter_source %}
            <button type="button" class="btn btn-sm btn-outline-danger btn-liquid" data-bs-toggle="modal" data-bs-target="#passwordModal" data-action="delete_source_results"><span class="btn-text">Delete All From Source</span></button>
            <input type="hidden" name="source_to_delete" value="{{ request.values.filter_source }}">
            {% endif %}

            <button type="submit" id="saveBtn" class="btn btn-sm btn-success btn-liquid" style="display:none;">
                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                <span class="btn-text">Save Changes</span>
            </button>
            <button type="button" id="cancelBtn" class="btn btn-sm btn-secondary btn-liquid" style="display:none;"><span class="btn-text">Cancel</span></button>
          </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 3%;"><input type="checkbox" class="form-check-input" id="select_all"></th>
                        <th>Email</th><th>Company</th><th>Quarter</th><th>Campaign</th><th>Source File</th><th>Exclusions</th><th>Uploaded</th>
                    </tr>
                </thead>
                <tbody>
                      {% for l in pagination.items %}
                    <tr data-lead-id="{{ l.id }}">
                        <td><input type="checkbox" class="form-check-input lead_checkbox" name="lead_ids" value="{{ l.id }}"></td>
                        <td><input name="email_{{ l.id }}" value="{{ l.email }}" readonly class="form-control-plaintext form-control-sm lead-input"></td>
                        <td><input name="company_{{ l.id }}" value="{{ l.company or '' }}" readonly class="form-control-plaintext form-control-sm lead-input"></td>
                        <td><input name="quarter_{{ l.id }}" value="{{ l.quarter or '' }}" readonly class="form-control-plaintext form-control-sm lead-input"></td>
                        <td><input name="campaign_{{ l.id }}" value="{{ l.campaign or '' }}" readonly class="form-control-plaintext form-control-sm lead-input"></td>
                        <td><input name="source_file_{{ l.id }}" value="{{ l.source_file or '' }}" readonly class="form-control-plaintext form-control-sm lead-input"></td>
                        <td><input name="exclusions_{{ l.id }}" value="{{ l.exclusions or '' }}" readonly class="form-control-plaintext form-control-sm lead-input"></td>
                        <td>{{ l.upload_date.strftime('%Y-%m-%d') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- PAGINATION CONTROLS -->
    <!-- PAGINATION CONTROLS (Corrected) -->
<div class="card-footer d-flex justify-content-center">
    <nav aria-label="Page navigation">
        <ul class="pagination mb-0">
            <!-- Previous Page Link -->
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                {% set prev_args = request.args.to_dict() %}
                {% do prev_args.update({'page': pagination.prev_num}) %}
                <a class="page-link" href="{{ url_for('tools', **prev_args) }}">&laquo;</a>
            </li>

            <!-- Numbered Page Links -->
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    <li class="page-item {% if pagination.page == page_num %}active{% endif %}">
                        {% set page_args = request.args.to_dict() %}
                        {% do page_args.update({'page': page_num}) %}
                        <a class="page-link" href="{{ url_for('tools', **page_args) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <!-- Next Page Link -->
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                {% set next_args = request.args.to_dict() %}
                {% do next_args.update({'page': pagination.next_num}) %}
                <a class="page-link" href="{{ url_for('tools', **next_args) }}">&raquo;</a>
            </li>
        </ul>
    </nav>
</div>
  
  <!-- Modal -->
  <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="passwordModalLabel">Admin Password Required</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="modal-prompt-text">Please enter the admin password to proceed.</p>
          <input type="password" class="form-control" id="modal_password_input" placeholder="Password" autocomplete="current-password">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span class="btn-text">Close</span></button>
          <button type="button" class="btn btn-primary" id="confirmPasswordBtn"><span class="btn-text">Confirm</span></button>
        </div>
      </div>
    </div>
  </div>

 <script>
document.addEventListener('DOMContentLoaded', function() {
  // Make sure the modal sits on <body>
  const modalEl = document.getElementById('passwordModal');
  if (modalEl && modalEl.parentElement !== document.body) {
    document.body.appendChild(modalEl);
  }

  const leadsForm       = document.getElementById('leadsForm');
  const saveBtn         = document.getElementById('saveBtn');
  const cancelBtn       = document.getElementById('cancelBtn');
  const btnDownloadSel  = document.getElementById('btnDownloadSelected');
  const btnDownloadAll  = document.getElementById('btnDownloadAll');
  const btnDownloadFilt = document.getElementById('btnDownloadFiltered');
  let currentAction = '';
  let actionTriggerButton = null;

  function getSelectedIds() {
    return Array.from(document.querySelectorAll('.lead_checkbox:checked')).map(cb => cb.value);
  }
  function disableAllRowInputs() {
    document.querySelectorAll('.lead-input').forEach(inp => inp.disabled = true);
  }

  // Bootstrap modal
  let bsModal = null;
  if (modalEl) { bsModal = new bootstrap.Modal(modalEl); }

  // Modal open-time logic
  modalEl?.addEventListener('show.bs.modal', function (event) {
    actionTriggerButton = event.relatedTarget || null;
    currentAction = actionTriggerButton ? actionTriggerButton.getAttribute('data-action') : '';
    document.getElementById('modal_password_input').value = '';

    const needsSelection = ['update_selected', 'delete_selected'];
    if (needsSelection.includes(currentAction) && getSelectedIds().length === 0) {
      event.preventDefault();
      alert('Please select at least one lead first.');
      return;
    }

    const promptText = document.getElementById('modal-prompt-text');
    if (currentAction === 'delete_selected') {
      promptText.textContent = `Enter password to DELETE ${getSelectedIds().length} lead(s). This deletes all records for those email(s) across all sources.`;
    } else if (currentAction === 'delete_source_results') {
      const sourceName = (document.querySelector('input[name="source_to_delete"]') || {}).value || '';
      promptText.textContent = `Enter password to DELETE ALL leads from source '${sourceName}'. This is permanent.`;
    } else {
      promptText.textContent = 'Please enter the admin password to proceed.';
    }
  });

  modalEl?.addEventListener('shown.bs.modal', () => {
    document.getElementById('modal_password_input')?.focus();
  });

  document.getElementById('confirmPasswordBtn')?.addEventListener('click', () => {
    const pwd = document.getElementById('modal_password_input').value.trim();
    if (!pwd) { 
      document.getElementById('modal_password_input').focus();
      return;
    }
    document.getElementById('admin_pass_hidden').value = pwd;
    document.getElementById('action_hidden').value     = currentAction;

    bsModal?.hide();

    if (currentAction === 'update_selected') {
      const ids = getSelectedIds();
      ids.forEach(id => {
        document.querySelectorAll(`tr[data-lead-id='${id}'] .lead-input`).forEach(input => {
          input.readOnly = false;
          input.classList.remove('form-control-plaintext');
          input.classList.add('form-control');
          input.disabled = false;
        });
      });
      saveBtn.style.display   = 'inline-flex';
      cancelBtn.style.display = 'inline-flex';
      document.querySelector(`tr[data-lead-id='${ids[0]}'] .lead-input`)?.focus();
    } else {
      if (actionTriggerButton) {
        actionTriggerButton.classList.add('loading');
        actionTriggerButton.disabled = true;
      }
      disableAllRowInputs();
      leadsForm.submit();
    }
  });

  // Table selection helpers
  document.getElementById('select_all')?.addEventListener('change', function () {
    document.querySelectorAll('.lead_checkbox').forEach(cb => { 
      cb.checked = this.checked;
      cb.closest('tr').classList.toggle('table-active', this.checked);
    });
  });
  document.querySelectorAll('.lead_checkbox').forEach(cb => {
    cb.addEventListener('change', function() {
      this.closest('tr').classList.toggle('table-active', this.checked);
    });
  });

  cancelBtn?.addEventListener('click', () => { window.location.reload(); });

  // Save inline edits
  saveBtn?.addEventListener('click', function (e) {
    if (!getSelectedIds().length) {
      e.preventDefault();
      alert('Please select at least one lead to save changes.');
      return;
    }
    const selected = new Set(getSelectedIds());
    document.querySelectorAll('tbody tr[data-lead-id]').forEach(tr => {
      const id = tr.getAttribute('data-lead-id');
      tr.querySelectorAll('.lead-input').forEach(input => {
        input.disabled = !selected.has(id);
      });
    });
    document.getElementById('action_hidden').value = 'update_selected';
  });

  // -------- DOWNLOAD ACTIONS (clean) --------
  function submitAction(actionName, buttonEl) {
    if (actionName === 'download_selected' && getSelectedIds().length === 0) {
      alert('Please select at least one lead to download.');
      return;
    }

    if (buttonEl) {
      buttonEl.classList.add('loading');
      buttonEl.disabled = true;

      // safety re-enable in case the browser doesn't navigate/reload
      setTimeout(function () {
        buttonEl.classList.remove('loading');
        buttonEl.disabled = false;
      }, 1500);
    }

    disableAllRowInputs();
    document.getElementById('action_hidden').value = actionName;
    leadsForm.submit();
  }

  // Wire buttons
  btnDownloadSel?.addEventListener('click', (e) => submitAction('download_selected', e.currentTarget));
  btnDownloadAll?.addEventListener('click', (e) => submitAction('download_all', e.currentTarget));
  btnDownloadFilt?.addEventListener('click', (e) => submitAction('download_filtered', e.currentTarget));

  // Generic "loading" for forms that actually use a submit button
  const forms = document.querySelectorAll('.needs-loading-spinner');
  forms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const submitBtn = e.submitter; // only if a real button was clicked
      if (submitBtn) {
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;
      }
    });
  });
});
</script>

  {% endif %}
</div>
{% endblock %}
